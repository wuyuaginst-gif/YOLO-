version: '3.8'

services:
  # OpenCV Platform 生产环境主服务
  opencv-platform:
    build:
      context: .
      dockerfile: Dockerfile.prod
    image: opencv-platform:latest
    container_name: opencv-platform-prod
    ports:
      - "8000:8000"
    volumes:
      # 持久化数据目录
      - ./data:/app/data
      # 持久化日志
      - ./logs:/app/logs
      # 只读配置文件
      - ./.env:/app/.env:ro
    environment:
      # 应用配置
      - APP_NAME=OpenCV Platform
      - APP_VERSION=1.0.0
      - DEBUG=False
      - API_PORT=8000
      
      # 数据路径
      - DATA_DIR=/app/data
      - DATASETS_DIR=/app/data/datasets
      - MODELS_DIR=/app/data/models
      - EXPORTS_DIR=/app/data/exports
      - UPLOADS_DIR=/app/data/uploads
      
      # Label Studio (如果使用外部服务)
      - LABEL_STUDIO_URL=http://host.docker.internal:8087
      
      # Python 配置
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    
    # 资源限制 (根据服务器配置调整)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    # 重启策略
    restart: unless-stopped
    
    # 网络配置
    networks:
      - opencv-network
    
    # 允许访问宿主机服务
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    # 健康检查
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/system/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# 网络配置
networks:
  opencv-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# 如果需要独立部署 Label Studio，取消下方注释
# 
# services:
#   labelstudio:
#     image: heartexlabs/label-studio:latest
#     container_name: labelstudio-service
#     ports:
#       - "8080:8080"
#     volumes:
#       - labelstudio-data:/label-studio/data
#     environment:
#       - LABEL_STUDIO_LOCAL_FILES_SERVING_ENABLED=true
#       - LABEL_STUDIO_LOCAL_FILES_DOCUMENT_ROOT=/label-studio/data
#     restart: unless-stopped
#     networks:
#       - opencv-network
# 
# volumes:
#   labelstudio-data:
#     driver: local
