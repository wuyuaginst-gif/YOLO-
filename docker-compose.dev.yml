services:
  opencv-platform-dev:
    build:
      context: .
      dockerfile: Dockerfile.prod
    image: opencv-platform:dev
    container_name: opencv-platform-dev
    ports:
      - "8000:8000"
    
    # ğŸ”¥ å…³é”®ä¼˜åŒ–ï¼šæŒ‚è½½ä»£ç ç›®å½•ï¼Œå®ç°çƒ­é‡è½½
    volumes:
      # æŒ‚è½½åº”ç”¨ä»£ç ï¼ˆä»£ç ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼‰
      - ./backend:/app/backend
      - ./frontend:/app/frontend
      - ./config:/app/config
      - ./app.py:/app/app.py
      
      # æŒ‚è½½æ•°æ®å’Œæ—¥å¿—ç›®å½•
      - ./data:/app/data
      - ./logs:/app/logs
      
      # æŒ‚è½½ç¯å¢ƒå˜é‡ï¼ˆåªè¯»ï¼‰
      - ./.env:/app/.env:ro
      
      # ä¸æŒ‚è½½ Python åŒ…ï¼ˆä½¿ç”¨å®¹å™¨å†…çš„ï¼‰
      # å¦‚æœéœ€è¦ä¿®æ”¹ä¾èµ–ï¼Œéœ€è¦é‡æ–°æ„å»ºé•œåƒ
    
    environment:
      # åº”ç”¨é…ç½®
      APP_NAME: "OpenCV Platform (Dev)"
      APP_VERSION: "1.0.0-dev"
      DEBUG: "True"
      API_PORT: 8000
      
      # è·¯å¾„é…ç½®
      DATA_DIR: /app/data
      DATASETS_DIR: /app/data/datasets
      MODELS_DIR: /app/data/models
      EXPORTS_DIR: /app/data/exports
      UPLOADS_DIR: /app/data/uploads
      

      
      # Python é…ç½®
      PYTHONUNBUFFERED: 1
      PYTHONPATH: /app
      
      # å¼€å‘æ¨¡å¼ç‰¹å®šé…ç½®
      RELOAD: "True"  # å¯ç”¨çƒ­é‡è½½
    
    # ğŸ”¥ ä½¿ç”¨çƒ­é‡è½½å‘½ä»¤ï¼ˆä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯ï¼‰
    command: >
      uvicorn app:app
      --host 0.0.0.0
      --port 8000
      --reload
      --reload-dir /app/backend
      --reload-dir /app/frontend
      --log-level info
    
    networks:
      - opencv-network
    
    extra_hosts:
      - "host.docker.internal:host-gateway"
    
    restart: unless-stopped
    
    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/system/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # æ—¥å¿—é…ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # èµ„æºé™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒé€‚å½“æ”¾å®½ï¼‰
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '1.0'
          memory: 2G

networks:
  opencv-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
