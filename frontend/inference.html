<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹æ¨ç† - OpenCV Platform</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">ğŸ¯ OpenCV Platform</a>
            <ul class="navbar-nav">
                <li><a href="/" class="nav-link">é¦–é¡µ</a></li>
                <li><a href="/inference" class="nav-link active">æ¨¡å‹æ¨ç†</a></li>
                <li><a href="/training" class="nav-link">æ¨¡å‹è®­ç»ƒ</a></li>
                <li><a href="/models" class="nav-link">æ¨¡å‹ç®¡ç†</a></li>
                <li><a href="/datasets" class="nav-link">æ•°æ®é›†</a></li>
                <li><a href="/labelstudio" class="nav-link">æ•°æ®æ ‡æ³¨</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-header">ğŸ” æ¨¡å‹æ¨ç†</div>
            
            <!-- é…ç½®é€‰é¡¹ -->
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label">æ¨¡å‹é€‰æ‹©</label>
                    <select id="model-select" class="form-control">
                        <option value="yolov8n.pt">YOLOv8n (nano)</option>
                        <option value="yolov8s.pt">YOLOv8s (small)</option>
                        <option value="yolov8m.pt">YOLOv8m (medium)</option>
                        <option value="yolov8l.pt">YOLOv8l (large)</option>
                        <option value="yolov8x.pt">YOLOv8x (extra large)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ç½®ä¿¡åº¦é˜ˆå€¼</label>
                    <input type="number" id="confidence" class="form-control" min="0" max="1" step="0.05" value="0.25">
                </div>
                <div class="form-group">
                    <label class="form-label">IOU é˜ˆå€¼</label>
                    <input type="number" id="iou" class="form-control" min="0" max="1" step="0.05" value="0.45">
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-area" id="upload-area">
                <h3>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</h3>
                <p style="color: var(--secondary-color);">æ”¯æŒ JPGã€PNGã€BMP æ ¼å¼</p>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" id="infer-btn" disabled>
                    å¼€å§‹æ¨ç†
                </button>
                <button class="btn btn-secondary" id="clear-btn">
                    æ¸…é™¤ç»“æœ
                </button>
            </div>
        </div>

        <!-- æ¨ç†ç»“æœ -->
        <div id="results-container" style="display: none;">
            <div class="card">
                <div class="card-header">ğŸ“Š æ¨ç†ç»“æœ</div>
                
                <div class="grid grid-2">
                    <!-- å›¾ç‰‡é¢„è§ˆ -->
                    <div>
                        <h4 style="margin-bottom: 1rem;">åŸå§‹å›¾ç‰‡</h4>
                        <canvas id="result-canvas" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></canvas>
                    </div>

                    <!-- æ£€æµ‹ä¿¡æ¯ -->
                    <div>
                        <h4 style="margin-bottom: 1rem;">æ£€æµ‹ä¿¡æ¯</h4>
                        <div style="background: var(--light-color); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p><strong>æ¨ç†æ—¶é—´:</strong> <span id="inference-time">-</span> ms</p>
                            <p><strong>å›¾ç‰‡å°ºå¯¸:</strong> <span id="image-size">-</span></p>
                            <p><strong>æ£€æµ‹æ•°é‡:</strong> <span id="detection-count">-</span></p>
                        </div>

                        <h4 style="margin-bottom: 0.5rem;">æ£€æµ‹å¯¹è±¡</h4>
                        <div id="detections-list" style="max-height: 400px; overflow-y: auto;">
                            <!-- æ£€æµ‹ç»“æœåˆ—è¡¨ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js"></script>
    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const inferBtn = document.getElementById('infer-btn');
        const clearBtn = document.getElementById('clear-btn');
        const resultsContainer = document.getElementById('results-container');
        const canvas = document.getElementById('result-canvas');
        const ctx = canvas.getContext('2d');

        let currentFile = null;

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»
        uploadArea.addEventListener('click', () => fileInput.click());

        // æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFile = file;
                inferBtn.disabled = false;
                uploadArea.innerHTML = `<h3>âœ“ å·²é€‰æ‹©: ${file.name}</h3>`;
            }
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                currentFile = file;
                inferBtn.disabled = false;
                uploadArea.innerHTML = `<h3>âœ“ å·²é€‰æ‹©: ${file.name}</h3>`;
            }
        });

        // å¼€å§‹æ¨ç†
        inferBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            inferBtn.disabled = true;
            inferBtn.innerHTML = '<span class="loading"></span> æ¨ç†ä¸­...';

            try {
                const options = {
                    model_name: document.getElementById('model-select').value,
                    confidence: parseFloat(document.getElementById('confidence').value),
                    iou_threshold: parseFloat(document.getElementById('iou').value)
                };

                const result = await API.inferImage(currentFile, options);

                if (result.success) {
                    displayResults(result, currentFile);
                    showAlert('æ¨ç†å®Œæˆ!', 'success');
                } else {
                    showAlert('æ¨ç†å¤±è´¥: ' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('æ¨ç†å‡ºé”™: ' + error.message, 'danger');
            } finally {
                inferBtn.disabled = false;
                inferBtn.textContent = 'å¼€å§‹æ¨ç†';
            }
        });

        // æ˜¾ç¤ºç»“æœ
        function displayResults(result, file) {
            resultsContainer.style.display = 'block';

            // æ˜¾ç¤ºæ¨ç†ä¿¡æ¯
            document.getElementById('inference-time').textContent = (result.inference_time * 1000).toFixed(2);
            document.getElementById('image-size').textContent = `${result.image_shape[1]} Ã— ${result.image_shape[0]}`;
            document.getElementById('detection-count').textContent = result.detections.length;

            // ç»˜åˆ¶å›¾ç‰‡å’Œæ£€æµ‹æ¡†
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                // ç»˜åˆ¶æ£€æµ‹æ¡†
                result.detections.forEach((det, idx) => {
                    const [x1, y1, x2, y2] = det.bbox;
                    const color = getColor(idx);

                    // ç»˜åˆ¶çŸ©å½¢æ¡†
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

                    // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
                    const label = `${det.class_name} ${(det.confidence * 100).toFixed(1)}%`;
                    ctx.font = '16px Arial';
                    const textWidth = ctx.measureText(label).width;
                    
                    ctx.fillStyle = color;
                    ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);

                    // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
                    ctx.fillStyle = 'white';
                    ctx.fillText(label, x1 + 5, y1 - 7);
                });
            };
            img.src = URL.createObjectURL(file);

            // æ˜¾ç¤ºæ£€æµ‹åˆ—è¡¨
            const detectionsList = document.getElementById('detections-list');
            detectionsList.innerHTML = result.detections.map((det, idx) => `
                <div class="detection-item" style="border-left: 4px solid ${getColor(idx)};">
                    <strong>${det.class_name}</strong>
                    <span class="badge badge-primary" style="float: right;">${(det.confidence * 100).toFixed(1)}%</span>
                    <br>
                    <small style="color: var(--secondary-color);">
                        åæ ‡: [${det.bbox.map(v => v.toFixed(1)).join(', ')}]
                    </small>
                </div>
            `).join('');
        }

        // æ¸…é™¤ç»“æœ
        clearBtn.addEventListener('click', () => {
            resultsContainer.style.display = 'none';
            currentFile = null;
            fileInput.value = '';
            inferBtn.disabled = true;
            uploadArea.innerHTML = '<h3>ğŸ“ ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</h3><p style="color: var(--secondary-color);">æ”¯æŒ JPGã€PNGã€BMP æ ¼å¼</p>';
        });

        // è·å–é¢œè‰²
        function getColor(index) {
            const colors = [
                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#6366f1'
            ];
            return colors[index % colors.length];
        }
    </script>
</body>
</html>
